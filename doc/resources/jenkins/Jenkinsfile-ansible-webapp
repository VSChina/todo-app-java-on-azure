node {
  stage('Setup') {
    sh '''
      ## Set up python environment
      curl 'https://bootstrap.pypa.io/get-pip.py' > get-pip.py && sudo python get-pip.pycurl 'https://bootstrap.pypa.io/get-pip.py' > get-pip.py && sudo python get-pip.py
      
      ## Install ansible
      sudo apt-get update
      sudo apt-get install software-properties-common -y
      sudo apt-add-repository ppa:ansible/ansible -y
      sudo apt-get update
      sudo apt-get install ansible
      
      ## Install Azure SDKs via pip
      sudo python -m pip install ansible[azure]
      
      ## Install Azure preview modules
      ansible-galaxy install Azure.azure_preview_modules
      python -m pip install -r  ~/.ansible/roles/Azure.azure_preview_modules/files/requirements-azure.txt --user
    '''
  }
  
  stage('Init') {
    checkout scm
  }

  stage('Build') {
    sh '''
        mvn clean package
        mv target/*.war ROOT.war
    '''
  }

  stage('Deploy') {
    withCredentials([azureServicePrincipal(credentialsId: env.AZURE_CRED_ID,
                                    subscriptionIdVariable: 'AZURE_SUBSCRIPTION_ID',
                                    clientIdVariable: 'AZURE_CLIENT_ID',
                                    clientSecretVariable: 'AZURE_SECRET',
                                    tenantIdVariable: 'AZURE_TENANT')]) {
                                      
      ansiblePlaybook playbook: 'deploy/ansible/webapp.yml', 
      sudo: true,
      sudoUser: 'env.JENKINS_ADMIN'
    }

    azureWebAppPublish azureCredentialsId: env.AZURE_CRED_ID,
                       resourceGroup: env.RES_GROUP, appName: env.WEB_APP_NAME, filePath: "ROOT.war"
  }
}