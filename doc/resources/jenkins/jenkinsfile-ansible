node {
  stage('Init') {
    sh '''
      ## Install pre-requisite packages
      ## sudo apt-get update && sudo apt-get install -y libssl-dev libffi-dev python-dev python-pip

      ## Install Ansible and Azure SDKs via pip
      python -m pip install ansible[azure]

      ansible-galaxy install Azure.azure_preview_modules
      python -m pip install -r  ~/.ansible/roles/Azure.azure_preview_modules/files/requirements-azure.txt --user
    '''
    checkout scm
  }

  stage('Build') {

  }

  stage('Unit Tests') {

  }

  stage('Integration Tests') {

  }

  stage('Analysis') {

  }

  stage('Upload Artifact') {

  }

  stage('Deploy') {
    def artifactUrl = "https://jenkinsdebug.file.core.windows.net/artifacts/app.war?sv=2017-11-09&ss=bfqt&srt=sco&sp=rwdlacup&se=2018-10-01T13:37:20Z&st=2018-08-24T05:37:20Z&spr=https&sig=2N22Ca7WOG9udDUZ%2B6WeGf6YUW8wiQD1OvpXZP6kGSI%3D"
    withEnv(["ARTIFACT_URL=${artifactUrl}", "APP_NAME=app"]) {
      withCredentials([azureServicePrincipal(credentialsId: 'sp-fix',
                                      subscriptionIdVariable: 'AZURE_SUBSCRIPTION_ID',
                                      clientIdVariable: 'AZURE_CLIENT_ID',
                                      clientSecretVariable: 'AZURE_SECRET',
                                      tenantIdVariable: 'AZURE_TENANT')]) {
        ansiblePlaybook colorized: true, 
        installation: 'ansible',
        playbook: 'deploy/ansible/webapp.yml', 
        sudo: true,
        sudoUser: 'jenkins'
      }
    }
  }
}